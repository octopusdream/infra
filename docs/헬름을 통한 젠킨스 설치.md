## 젠킨스 설치를 위한 간편화 도구

### 커스터마이즈

오브젝트를 사용자의 의도에 따라 유동적으로 배포할 수 있다.

별도의 커스터마이즈 실행 파일을 활용해 커스터마이즈 명세를 따르는 야물 파일을 생성할 수 있다.

야믈 파일이 이미 존재한다면 kubectl로도 배포할 수 있는 옵션(-k)이 있을 정도로 kubectl과 매우 밀접하게 동작한다.

커스터마이즈는 명세와 관련된 야믈 파일에 변수나 템플릿을 사용하지는 않지만, 명령어로 배포 대상 오브젝트의 이미지 태그와 레이블 같은 명세를 변경하거나 일반 파일을 이용해 컨피그맵과 시크릿을 생성하는 기능을 지원한다.

그래서 운영 중인 환경에서 배포 시 가변적인 요소를 적용하는데 적합하다.

### 헬름

헬름은 쿠버네티스 사용자의 70% 이상이 사용하고 있을 정도로 널리 알려진 도구로, 오브젝트 배포에 필요한 사양이 이미 정의된 차트라는 패키지를 활용한다.

앞선 두 가지 도구와 달리 헬름 파트 저장소가 온라인에 있기 때문에 패키지를 검색하고 내려받아 사용하기가 매우 간편하다.

헬름 파트는 자체적인 템플릿 문법을 사용하므로 가변적인 인자를 배포할 때 적용해 다양한 배포 환경에 맞추거나 원하는 조건을 적용할 수 있다.

헬름은 오브젝트를 묶어 패키지 단위로 관리하므로 단순한 1개의 명령어로 애플리케이션에 필요한 오브젝트들을 구성할 수 있다.

### 젠킨스 설치를 위한 간편화 도구 선택

헬름이 우선적으로 쿠버네티스 사용자들 사이에서 많이 사용되기도 하고, 가변적인 환경에서 복잡한 대응이 가능하다는 점, 패키지를 내려받아 바로 사용하기 간편하다는 점에서 이번 프로젝트에서는 헬름을 통해서 젠킨스를 설치하기로 결정하였다.

## 헬름 작동 원리

헬름은 쿠버네티스 패키지를 손쉽게 배포할 수 있도록 패키지를 관리하는 쿠버네티스 전용 패키지 매니저이다.

일반적으로 패키지는 실행 파일뿐만 아니라 실행 환경에 필요한 의존성 파일과 환경 정보들의 묶음이다.

그리고 패키지 매니저는 외부에 있는 저장소에서 패키지 정보를 받아와 패키지를 안정적으로 관리하는 도구이다.

패키지 매니저는 다양한 목적으로 사용되지만, 가장 중요한 목적은 설치에 필요한 의존성 파일들을 관리하고 간편하게 설치할 수 있도록 도와주는 것이다.

컨테이너 인프라 환경에서 애플리케이션을 배포하려면 ConfigMap, ServiceAccount, PV, PVC, Secret 등 애플리케이션 배포 구성에 필요한 모든 쿠버네티스 오브젝트를 작성하고, kubectl 명령을 실행해서 쿠버네티스 클러스터에 설치해야 한다.

이때, 커스터마이즈를 사용하면 많은 부분을 환경에 맞춰 변경할 수 있지만, 주소 할당 영역과 같은 정보는 값의 형태가 아니라서 변경할 수 없다.

이런 경우 헬름을 사용하면 주소 할당 영역도 변경이 가능하다.

또한, 헬름을 사용하면 요구 조건 별로 리소스를 편집하거나 변수를 넘겨서 처리하는 패키지를 만들 수 있다.

이렇게 다양한 요구 조건을 처리할 수 있는 패키지를 차트라고 하는데, 이를 헬름 저장소에 공개해 여러 사용자와 공유한다.

각 사용자는 공개된 저장소에 등록된 차트를 이용해서 애플리케이션을 원하는 형태로 쿠버네티스에 배포할 수 있다.

헬름을 이용하면 하나의 패키지로 다양한 사용자가 원하는 각자의 환경을 구성할 수 있으며 이를 자유롭게 배포, 관리, 삭제할 수 있다.

![image](https://user-images.githubusercontent.com/93571332/200255648-a6aca347-c87f-442c-a9e3-d22e8c410f8b.png)

위에 그림은 헬름의 전반적인 흐름이다.

### 생산자 영역

생산자가 헬름 명령으로 작업 공간을 생성하면 templates 디렉터리로 애플리케이션 배포에 필요한 여러 야믈 파일과 구성 파일을 작성할 수 있다.

이때 templates 디렉터리에서 조건별 분기, 값 전달 등을 처리할 수 있도록 values.yaml 에 설정된 키를 사용한다.

이때 값이 전달되지 않으면 기본값으로 처리하도록 values.yaml 에 설정할 수 있다.

이렇게 필요한 패키지의 여러 분기 처리나 배포에 대한 구성이 완료되면 생산자는 차트의 이름, 목적, 배포되는 애플리케이션 버전과 같은 패키지 정보를 Chart.yaml 에 채워 넣는다.

앞의 과정을 모두 거쳐 차트 구성이 완료되면 생산자가 생산자 저장소에 업로드한다.

그리고 업로드한 생산자 저장소를 아티팩트허브에 등록하면 사용자는 아티팩트허브에서 생산자가 만든 저장소를 찾을 수 있다.

### 아티팩트허브 영역

헬름 기본 저장소는 아티팩트허브로, 다른 패키지 매니저처럼 외부에 있다.

다른 저장소와 달리 아티팩트허브에서는 설치할 패키지에 대한 경로만 제공한다.

아티팩트허브 검색을 통해 사용자가 찾고자 하는 애플리케이션 패키지를 검색하면 해당 패키지가 저장된 주소를 확인한다.

이렇게 확인한 주소는 각 애플리케이션을 개발하는 주체가 관리한다.

### 사용자 영역

사용자는 설치하려는 애플리케이션의 차트 저장소 주소를 아티팩트허브에서 얻으면 헬름을 통해서 주소를 등록한다.

그리고 이를 최신으로 업데이트 한 이후에 차트를 내려받고 설치한다.

이렇게 헬름을 통해 쿠버네티스에 설치된 애플리케이션 패키지를 릴리스라고 한다.

헬름을 통해 배포된 릴리스를 다시 차트를 사용해 업그레이드할 수 있고 원래대로 되돌릴 수 있다. 

사용하지 않은 헬름 릴리스를 제거할 수도 있다.

## 젠킨스 구조

젠킨스 컨트롤러는 마스터 노드에 설치했지만 젠킨스 에이전트는 필요 시에 생성되고 작업을 마치면 삭제되는 임시적인 구조를 가진다.

따라서 젠킨스 에이전트 작업 내용들은 삭제 전에 젠킨스 컨트롤러에 저장돼야 하며, 이를 위해 젠킨스 에이전트 서비스가 항상 동작하고 있다.

젠킨스 컨트롤러가 단독으로 설치될 경우에는 컨트롤러가 설치된 서버에서 젠킨스 자체 시스템 관리 CI/CD 설정, 빌드 등의 작업을 모두 젠킨스 컨트롤러 단일 노드에서 수행한다.

하지만, 컨트롤러-에이전트 구조로 설치할 경우 컨트롤러는 젠킨스 자체의 관리 및 CI/CD와 관련된 설정만을 담당하고 실제 빌드 작업은 에이전트로 설정된 노드에서 이루어진다.

따라서 컨트롤러 단독 설치는 일반적으로 간단한 테스트에서만 사용되고 주로 컨트롤러-에이전트 구조로 사용하기 때문에 이 책에서는 컨트롤러-에이전트 환경으로 구성하였다.
